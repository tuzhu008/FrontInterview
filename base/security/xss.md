# XSS

XSS 是 Cross-site Script 的简称，跨站脚本攻击。

为了和 CSS 区分，这里把攻击的第一个字母改成了 X，于是叫做 XSS。

跨站脚本攻击是一种安全漏洞，攻击者可以利用这种漏洞在网站上注入恶意的客户端代码。当被攻击者登陆网站时就会自动运行这些恶意代码，从而，攻击者可以突破网站的访问权限，冒充受害者。

**XSS 的本质是**：恶意代码未经过滤，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。

XSS 攻击可以分为3类：存储型（持久型）、反射型（非持久型）、DOM 型。

* **存储型 XSS**

  注入型脚本永久存储在目标服务器上。当浏览器请求数据时，脚本从服务器上传回并执行。

  1. 攻击者将恶意代码提交到目标网站的数据库中。
  
  2. 用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。
  
  3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
  
  4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

* **反射型 XSS**

  当用户点击一个恶意链接，或者提交一个表单，或者进入一个恶意网站时，注入脚本进入被攻击者的网站。Web服务器将注入脚本，比如一个错误信息，搜索结果等 返回到用户的浏览器上。由于浏览器认为这个响应来自"可信任"的服务器，所以会执行这段脚本。

  1. 攻击者构造出特殊的 URL，其中包含恶意代码。
  
  2. 用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。
  
  3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
  
  4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

  反射型 XSS 跟存储型 XSS 的区别是：存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里。

  反射型 XSS 漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等。

  由于需要用户主动打开恶意的 URL 才能生效，攻击者往往会结合多种手段诱导用户点击。

  POST 的内容也可以触发反射型 XSS，只不过其触发条件比较苛刻（需要构造表单提交页面，并引导用户点击），所以非常少见。

* **基于 DOM 的 XSS**

  通过修改原始的客户端代码，受害者浏览器的 DOM 环境改变，导致有效载荷的执行。也就是说，页面本身并没有变化，但由于DOM环境被恶意修改，有客户端代码被包含进了页面，并且意外执行。

  1. 攻击者构造出特殊的 URL，其中包含恶意代码。
  
  2. 用户打开带有恶意代码的 URL。

  3. 用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。

  4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

## 攻击方法

* 在 HTML 中内嵌的文本中，恶意内容以 `script` 标签形成注入。

* 在内联的 JavaScript 中，拼接的数据突破了原本的限制（字符串，变量，方法名等）。

* 在标签属性中，恶意内容包含引号，从而突破属性值的限制，注入其他属性或者标签。

* 在标签的 `href`、`src` 等属性中，包含 `javascript:` 等可执行代码。

* 在 `onload`、`onerror`、`onclick` 等事件中，注入不受控制代码。

* 在 `style` 属性和标签中，包含类似 `background-image:url("javascript:...");` 的代码（新版本浏览器已经可以防范）。

* 在 `style` 属性和标签中，包含类似 `expression(...)` 的 CSS 表达式代码（新版本浏览器已经可以防范）。

## 解决方案

* 转义

  HTML 转义是非常复杂的，在不同的情况下要采用不同的转义规则。如果采用了错误的转义规则，很有可能会埋下 XSS 隐患。

  应当尽量避免自己写转义库，而应当采用成熟的、业界通用的转义库。

* 防范 `javascript:` 等非法模式的链接

## 参考

* [https://segmentfault.com/a/1190000016551188](https://segmentfault.com/a/1190000016551188)



